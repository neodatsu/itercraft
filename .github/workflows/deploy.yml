name: Deploy to ECR

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      tag:
        description: 'Tag to deploy (e.g., v0.0.10)'
        required: true
        type: string

permissions:
  contents: read
  id-token: write

jobs:
  deploy:
    name: Build & Push Docker images to ECR
    runs-on: ubuntu-latest
    environment: itercraft

    env:
      AWS_REGION: eu-west-1
      AWS_ACCOUNT_ID: ${{ secrets.AWS_ACCOUNT_ID }}
      DOMAIN_NAME: itercraft.com

    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event_name == 'workflow_dispatch' && inputs.tag || github.ref }}

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::${{ secrets.AWS_ACCOUNT_ID }}:role/github-actions-ecr-push
          aws-region: eu-west-1

      - name: Login to ECR
        run: aws ecr get-login-password --region $AWS_REGION | docker login --username AWS --password-stdin $AWS_ACCOUNT_ID.dkr.ecr.$AWS_REGION.amazonaws.com

      - name: Extract version from tag
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "TAG=${{ inputs.tag }}" >> "$GITHUB_OUTPUT"
          else
            echo "TAG=${GITHUB_REF_NAME}" >> "$GITHUB_OUTPUT"
          fi

      - name: Clean existing images from ECR
        run: |
          REPOS=(itercraft_front itercraft_api itercraft_authent itercraft_bdd itercraft_prometheus itercraft_grafana itercraft_mosquitto)
          for REPO in "${REPOS[@]}"; do
            echo "Cleaning $REPO..."
            IMAGE_IDS=$(aws ecr list-images --repository-name "$REPO" --region "$AWS_REGION" --query 'imageIds[*]' --output json)
            if [ "$IMAGE_IDS" != "[]" ]; then
              aws ecr batch-delete-image --repository-name "$REPO" --region "$AWS_REGION" --image-ids "$IMAGE_IDS"
            fi
          done

      - name: Build and push images
        run: |
          ECR=$AWS_ACCOUNT_ID.dkr.ecr.$AWS_REGION.amazonaws.com
          TAG=${{ steps.version.outputs.TAG }}

          # Front (with build args for production URLs)
          docker build -f devsecops/docker/Dockerfile.front \
            --build-arg VITE_KEYCLOAK_URL=https://authent.$DOMAIN_NAME \
            --build-arg VITE_KEYCLOAK_REALM=itercraft \
            --build-arg VITE_API_URL=https://api.$DOMAIN_NAME \
            -t "$ECR/itercraft_front:$TAG" -t "$ECR/itercraft_front:latest" .
          docker push "$ECR/itercraft_front:$TAG"
          docker push "$ECR/itercraft_front:latest"

          # Other images (no build args needed)
          images=(
            "itercraft_api:devsecops/docker/Dockerfile"
            "itercraft_authent:devsecops/docker/Dockerfile.keycloak"
            "itercraft_bdd:devsecops/docker/Dockerfile.postgres"
            "itercraft_prometheus:devsecops/docker/Dockerfile.prometheus"
            "itercraft_grafana:devsecops/docker/Dockerfile.grafana"
          )

          for entry in "${images[@]}"; do
            REPO="${entry%%:*}"
            DOCKERFILE="${entry#*:}"
            echo "Building $REPO from $DOCKERFILE"
            docker build -f "$DOCKERFILE" -t "$ECR/$REPO:$TAG" -t "$ECR/$REPO:latest" .
            docker push "$ECR/$REPO:$TAG"
            docker push "$ECR/$REPO:latest"
          done

          # Mosquitto (different build context)
          echo "Building itercraft_mosquitto"
          docker build -t "$ECR/itercraft_mosquitto:$TAG" -t "$ECR/itercraft_mosquitto:latest" iot/mosquitto
          docker push "$ECR/itercraft_mosquitto:$TAG"
          docker push "$ECR/itercraft_mosquitto:latest"
