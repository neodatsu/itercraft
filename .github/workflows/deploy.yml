name: Deploy to ECR

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      tag:
        description: 'Tag to deploy (e.g., v0.0.10)'
        required: true
        type: string

permissions:
  contents: read
  id-token: write

jobs:
  deploy:
    name: Build & Push Docker images to ECR
    runs-on: ubuntu-latest
    environment: itercraft

    env:
      AWS_REGION: eu-west-1
      AWS_ACCOUNT_ID: ${{ secrets.AWS_ACCOUNT_ID }}
      DOMAIN_NAME: itercraft.com

    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ inputs.tag || github.ref }}

      - name: Mask AWS Account ID
        run: echo "::add-mask::${{ secrets.AWS_ACCOUNT_ID }}"

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::${{ secrets.AWS_ACCOUNT_ID }}:role/github-actions-ecr-push
          aws-region: eu-west-1

      - name: Login to ECR
        run: aws ecr get-login-password --region $AWS_REGION | docker login --username AWS --password-stdin $AWS_ACCOUNT_ID.dkr.ecr.$AWS_REGION.amazonaws.com

      - name: Extract version from tag
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "TAG=${{ inputs.tag }}" >> "$GITHUB_OUTPUT"
          elif [ "${{ github.ref_type }}" = "tag" ]; then
            echo "TAG=${GITHUB_REF_NAME}" >> "$GITHUB_OUTPUT"
          else
            # Push to main branch - use commit SHA short
            echo "TAG=sha-${GITHUB_SHA::7}" >> "$GITHUB_OUTPUT"
          fi

      - name: Clean existing images from ECR
        run: |
          REPOS=(itercraft_front itercraft_api itercraft_authent itercraft_bdd itercraft_prometheus itercraft_grafana itercraft_mosquitto itercraft_loki itercraft_promtail itercraft_tempo itercraft_falco itercraft_falcosidekick)
          for REPO in "${REPOS[@]}"; do
            echo "Cleaning $REPO..."
            IMAGE_IDS=$(aws ecr list-images --repository-name "$REPO" --region "$AWS_REGION" --query 'imageIds[*]' --output json 2>/dev/null || echo "[]")
            if [ "$IMAGE_IDS" != "[]" ]; then
              aws ecr batch-delete-image --repository-name "$REPO" --region "$AWS_REGION" --image-ids "$IMAGE_IDS" || true
            fi
          done

      - name: Install Trivy
        run: |
          sudo apt-get install -y wget apt-transport-https gnupg lsb-release
          wget -qO - https://aquasecurity.github.io/trivy-repo/deb/public.key | sudo apt-key add -
          echo deb https://aquasecurity.github.io/trivy-repo/deb $(lsb_release -sc) main | sudo tee /etc/apt/sources.list.d/trivy.list
          sudo apt-get update
          sudo apt-get install -y trivy

      - name: Build images
        run: |
          ECR=$AWS_ACCOUNT_ID.dkr.ecr.$AWS_REGION.amazonaws.com
          TAG=${{ steps.version.outputs.TAG }}

          # Front (with build args for production URLs)
          docker build -f devsecops/docker/Dockerfile.front \
            --build-arg VITE_KEYCLOAK_URL=https://authent.$DOMAIN_NAME \
            --build-arg VITE_KEYCLOAK_REALM=itercraft \
            --build-arg VITE_API_URL=https://api.$DOMAIN_NAME \
            -t "$ECR/itercraft_front:$TAG" -t "$ECR/itercraft_front:latest" .

          # Other images (no build args needed)
          images=(
            "itercraft_api:devsecops/docker/Dockerfile"
            "itercraft_authent:devsecops/docker/Dockerfile.keycloak"
            "itercraft_bdd:devsecops/docker/Dockerfile.postgres"
            "itercraft_prometheus:devsecops/docker/Dockerfile.prometheus"
            "itercraft_grafana:devsecops/docker/Dockerfile.grafana"
            "itercraft_loki:devsecops/docker/Dockerfile.loki"
            "itercraft_promtail:devsecops/docker/Dockerfile.promtail"
            "itercraft_tempo:devsecops/docker/Dockerfile.tempo"
            "itercraft_falco:devsecops/docker/Dockerfile.falco"
            "itercraft_falcosidekick:devsecops/docker/Dockerfile.falcosidekick"
          )

          for entry in "${images[@]}"; do
            REPO="${entry%%:*}"
            DOCKERFILE="${entry#*:}"
            echo "Building $REPO from $DOCKERFILE"
            docker build -f "$DOCKERFILE" -t "$ECR/$REPO:$TAG" -t "$ECR/$REPO:latest" .
          done

          # Mosquitto (different build context)
          echo "Building itercraft_mosquitto"
          docker build -t "$ECR/itercraft_mosquitto:$TAG" -t "$ECR/itercraft_mosquitto:latest" iot/mosquitto

      - name: Scan images with Trivy
        run: |
          ECR=$AWS_ACCOUNT_ID.dkr.ecr.$AWS_REGION.amazonaws.com
          TAG=${{ steps.version.outputs.TAG }}
          mkdir -p trivy-reports

          IMAGES=(itercraft_front itercraft_api itercraft_authent itercraft_bdd itercraft_prometheus itercraft_grafana itercraft_mosquitto itercraft_loki itercraft_promtail itercraft_tempo itercraft_falco itercraft_falcosidekick)

          for IMG in "${IMAGES[@]}"; do
            echo "üîç Scanning $IMG..."
            trivy image --severity HIGH,CRITICAL --format table "$ECR/$IMG:$TAG" | tee "trivy-reports/$IMG.txt"
            # Fail on CRITICAL only (HIGH are warnings)
            trivy image --severity CRITICAL --exit-code 1 "$ECR/$IMG:$TAG" || {
              echo "‚ùå CRITICAL vulnerabilities found in $IMG"
              exit 1
            }
          done
          echo "‚úÖ All images passed Trivy scan"

      - name: Upload Trivy reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: trivy-image-reports
          path: trivy-reports/

      - name: Push images to ECR
        run: |
          ECR=$AWS_ACCOUNT_ID.dkr.ecr.$AWS_REGION.amazonaws.com
          TAG=${{ steps.version.outputs.TAG }}

          IMAGES=(itercraft_front itercraft_api itercraft_authent itercraft_bdd itercraft_prometheus itercraft_grafana itercraft_mosquitto itercraft_loki itercraft_promtail itercraft_tempo itercraft_falco itercraft_falcosidekick)

          for IMG in "${IMAGES[@]}"; do
            echo "üì§ Pushing $IMG..."
            docker push "$ECR/$IMG:$TAG"
            docker push "$ECR/$IMG:latest"
          done
