services:
  postgres:
    build:
      context: ../..
      dockerfile: devsecops/docker/Dockerfile.postgres
    container_name: itercraft-postgres
    ports:
      - "5432:5432"
    environment:
      POSTGRES_DB: itercraft
      POSTGRES_USER: itercraft
      POSTGRES_PASSWORD: itercraft
    volumes:
      - postgres-data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U itercraft"]
      interval: 5s
      timeout: 5s
      retries: 5
    networks:
      - itercraft-dev

  keycloak:
    build:
      context: ../..
      dockerfile: devsecops/docker/Dockerfile.keycloak
    container_name: itercraft-keycloak
    ports:
      - "8180:8180"
    environment:
      KC_HTTP_PORT: "8180"
      KC_BOOTSTRAP_ADMIN_USERNAME: admin
      KC_BOOTSTRAP_ADMIN_PASSWORD: admin
      KC_HOSTNAME: localhost
      KEYCLOAK_HEALTHCHECK_PASSWORD: healthcheck
      KEYCLOAK_LAURENT_PASSWORD: ${KEYCLOAK_LAURENT_PASSWORD:-changeme}
      KEYCLOAK_SSL_REQUIRED: none
    healthcheck:
      test: ["CMD-SHELL", "cat < /dev/null > /dev/tcp/localhost/8180"]
      interval: 10s
      timeout: 5s
      retries: 15
      start_period: 60s
    networks:
      - itercraft-dev

  api:
    build:
      context: ../..
      dockerfile: devsecops/docker/Dockerfile
    container_name: itercraft-api
    ports:
      - "8080:8080"
    environment:
      DB_HOST: postgres
      DB_PORT: "5432"
      DB_NAME: itercraft
      DB_USER: itercraft
      DB_PASSWORD: itercraft
      KEYCLOAK_INTERNAL_URL: http://keycloak:8180
      KEYCLOAK_REALM: itercraft
      KEYCLOAK_ISSUER_URI: http://localhost:8180/realms/itercraft
      CORS_ORIGINS: http://localhost:3000
      METEOFRANCE_API_TOKEN: ${METEOFRANCE_API_TOKEN:-changeme}
      ANTHROPIC_API_KEY: ${ANTHROPIC_API_KEY:-changeme}
      OTLP_ENDPOINT: http://localhost:4318/v1/traces
      INIT_USER_EMAIL: ${INIT_USER_EMAIL:-laurent@itercraft.com}
    depends_on:
      postgres:
        condition: service_healthy
      keycloak:
        condition: service_healthy
    networks:
      - itercraft-dev

  front:
    build:
      context: ../..
      dockerfile: devsecops/docker/Dockerfile.front
      args:
        VITE_KEYCLOAK_URL: http://localhost:8180
        VITE_KEYCLOAK_REALM: itercraft
        VITE_API_URL: http://localhost:8080
    container_name: itercraft-front
    ports:
      - "3000:3000"
    depends_on:
      - api
    networks:
      - itercraft-dev

networks:
  itercraft-dev:
    driver: bridge

volumes:
  postgres-data:
