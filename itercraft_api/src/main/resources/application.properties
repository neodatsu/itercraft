spring.application.name=itercraft-api
server.port=8080
server.forward-headers-strategy=FRAMEWORK

# Datasource
spring.datasource.url=jdbc:postgresql://${DB_HOST:localhost}:${DB_PORT:5432}/${DB_NAME:itercraft}
spring.datasource.username=${DB_USER:itercraft}
spring.datasource.password=${DB_PASSWORD:itercraft}
spring.jpa.properties.hibernate.default_schema=itercraft
spring.jpa.hibernate.ddl-auto=validate

# OAuth2 Resource Server - JWT (Keycloak)
# JWK Set URI for fetching public keys (internal Docker URL)
spring.security.oauth2.resourceserver.jwt.jwk-set-uri=${KEYCLOAK_INTERNAL_URL:http://keycloak:8180}/realms/${KEYCLOAK_REALM:itercraft}/protocol/openid-connect/certs
# Expected issuer in JWT (external URL seen by frontend)
spring.security.oauth2.resourceserver.jwt.issuer-uri=${KEYCLOAK_ISSUER_URI:http://localhost:8180/realms/itercraft}

# CORS
cors.allowed-origins=${CORS_ORIGINS:http://localhost:3000}

# Actuator / Prometheus
management.endpoints.web.exposure.include=health,prometheus
management.endpoint.prometheus.enabled=true
management.prometheus.metrics.export.enabled=true

# Distributed Tracing (OpenTelemetry / Tempo)
management.tracing.export.enabled=true
management.tracing.sampling.probability=1.0
management.opentelemetry.tracing.export.otlp.endpoint=${OTLP_ENDPOINT:http://tempo:4318/v1/traces}
# Disable OTLP metrics export (we use Prometheus pull via /actuator/prometheus)
management.otlp.metrics.export.enabled=false

# Météo France API (AROME PI)
meteofrance.api.token=${METEOFRANCE_API_TOKEN:changeme}
meteofrance.api.base-url=https://public-api.meteofrance.fr/public/aromepi/1.0

# Claude API (weather image analysis)
anthropic.api.key=${ANTHROPIC_API_KEY:changeme}
anthropic.model=${ANTHROPIC_MODEL:claude-sonnet-4-20250514}

# Resilience4j Circuit Breaker
resilience4j.circuitbreaker.instances.meteoFrance.sliding-window-size=10
resilience4j.circuitbreaker.instances.meteoFrance.failure-rate-threshold=50
resilience4j.circuitbreaker.instances.meteoFrance.wait-duration-in-open-state=30s
resilience4j.circuitbreaker.instances.meteoFrance.permitted-number-of-calls-in-half-open-state=3
resilience4j.circuitbreaker.instances.meteoFrance.register-health-indicator=true

resilience4j.circuitbreaker.instances.claude.sliding-window-size=5
resilience4j.circuitbreaker.instances.claude.failure-rate-threshold=50
resilience4j.circuitbreaker.instances.claude.wait-duration-in-open-state=60s
resilience4j.circuitbreaker.instances.claude.permitted-number-of-calls-in-half-open-state=2
resilience4j.circuitbreaker.instances.claude.register-health-indicator=true

# Resilience4j Retry
resilience4j.retry.instances.meteoFrance.max-attempts=3
resilience4j.retry.instances.meteoFrance.wait-duration=1s
resilience4j.retry.instances.meteoFrance.exponential-backoff-multiplier=2

# Resilience4j Time Limiter
resilience4j.timelimiter.instances.meteoFrance.timeout-duration=10s
resilience4j.timelimiter.instances.claude.timeout-duration=60s

# Expose circuit breaker health in actuator
management.health.circuitbreakers.enabled=true
management.endpoints.web.exposure.include=health,prometheus,circuitbreakers,circuitbreakerevents

# MQTT (Mosquitto)
mqtt.broker-url=ssl://${MQTT_HOST:localhost}:${MQTT_PORT:8883}
mqtt.username=${MQTT_BACKEND_USER:itercraft-backend}
mqtt.password=${MQTT_BACKEND_PASSWORD:changeme}
mqtt.client-id=${MQTT_CLIENT_ID:itercraft-api}
mqtt.topic=sensors/#
mqtt.trust-all-certificates=${MQTT_TRUST_ALL_CERTS:false}

# Ludothèque - email de l'utilisateur dont la collection est auto-initialisée au premier accès
ludotheque.init-user-email=${INIT_USER_EMAIL:laurent@itercraft.com}
